rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===== FUNCIONES HELPER DE AUTENTICACI√ìN Y AUTORIZACI√ìN =====

    // Verificar si el usuario est√° autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Verificar si es el propietario del documento
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ‚úÖ CORREGIDO: Verificar si es administrador (usar 'userType' en vez de 'role')
    function isAdmin() {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'admin';
    }

    // Verificar si es conductor (incluye dual)
    function isDriver() {
      return isAuthenticated() &&
             (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'driver' ||
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'dual');
    }

    // ‚úÖ CR√çTICO: Detectar si se intenta modificar campos protegidos
    // Estos campos SOLO pueden ser modificados por administradores
    function hasProtectedFieldChanges() {
      return request.resource.data.diff(resource.data).affectedKeys()
        .hasAny(['isAdmin', 'isVerified', 'email', 'id', 'createdAt', 'rating', 'totalTrips']);
    }

    // ‚úÖ NUEVO: Validar upgrade a conductor leg√≠timo
    // Permite cambiar userType SOLO de 'passenger' a 'dual' con driverStatus 'pending_approval'
    function isValidDriverUpgrade() {
      let oldType = resource.data.userType;
      let newType = request.resource.data.userType;
      let newStatus = request.resource.data.get('driverStatus', '');
      let newMode = request.resource.data.get('currentMode', '');
      let newRoles = request.resource.data.get('availableRoles', []);

      return oldType == 'passenger' &&
             newType == 'dual' &&
             newStatus == 'pending_approval' &&
             newMode == 'driver' &&
             newRoles.hasAll(['passenger', 'driver']) &&
             newRoles.size() == 2;
    }

    // ===== REGLAS PARA COLECCI√ìN DE USUARIOS =====

    match /users/{userId} {
      // ‚úÖ SEPARADO: get (documento individual) vs list (queries de colecci√≥n)
      // GET: El usuario puede leer su propio documento o admin puede leer cualquiera
      allow get: if isOwner(userId) || isAdmin();

      // LIST: Solo administradores pueden hacer queries que retornen m√∫ltiples usuarios
      // Esto previene que usuarios normales hagan Query(users) y vean todos los documentos
      allow list: if isAdmin();

      // Creaci√≥n: Cualquier usuario autenticado (registro)
      allow create: if isAuthenticated();

      // ‚úÖ CORREGIDO: Actualizaci√≥n con protecci√≥n contra escalaci√≥n de privilegios
      // Usuario normal: NO puede cambiar campos protegidos EXCEPTO upgrade a conductor v√°lido
      allow update: if isOwner(userId) && (!hasProtectedFieldChanges() || isValidDriverUpgrade());

      // Administrador: PUEDE actualizar cualquier campo
      allow update: if isAdmin();

      // Eliminaci√≥n: Solo administradores
      allow delete: if isAdmin();

      // ===== SUBCOLECCI√ìN: LUGARES FAVORITOS DEL USUARIO =====
      match /favorites/{favoriteId} {
        // Lectura: Solo el propietario del documento padre (usuario)
        allow read: if isOwner(userId);

        // Creaci√≥n: Solo el propietario puede agregar favoritos a su colecci√≥n
        allow create: if isOwner(userId);

        // Actualizaci√≥n: Solo el propietario puede editar sus favoritos
        allow update: if isOwner(userId);

        // Eliminaci√≥n: Solo el propietario puede eliminar sus favoritos
        allow delete: if isOwner(userId);
      }
    }

    // ===== REGLAS PARA CONDUCTORES =====

    match /drivers/{driverId} {
      // Lectura: Cualquier usuario autenticado (para ver conductores disponibles)
      allow read: if isAuthenticated();

      // Creaci√≥n: Usuario creando su propio perfil de conductor
      allow create: if isAuthenticated() && request.auth.uid == driverId;

      // Actualizaci√≥n: El conductor mismo o un administrador
      allow update: if isOwner(driverId) || isAdmin();

      // Eliminaci√≥n: Solo administradores
      allow delete: if isAdmin();

      // ===== SUBCOLECCI√ìN: DOCUMENTOS DEL CONDUCTOR =====
      match /documents/{documentId} {
        // Lectura: El conductor propietario o administrador
        allow read: if isOwner(driverId) || isAdmin();

        // Creaci√≥n: El conductor puede subir sus propios documentos
        allow create: if isOwner(driverId);

        // Actualizaci√≥n: El conductor o administrador (para actualizar estado de aprobaci√≥n)
        allow update: if isOwner(driverId) || isAdmin();

        // Eliminaci√≥n: El conductor o administrador
        allow delete: if isOwner(driverId) || isAdmin();
      }
    }

    // ===== REGLAS PARA PASAJEROS =====

    match /passengers/{passengerId} {
      // Lectura: El pasajero mismo, conductores, o admin
      allow read: if isOwner(passengerId) || isDriver() || isAdmin();

      // Creaci√≥n: El pasajero mismo al registrarse
      allow create: if isAuthenticated() && request.auth.uid == passengerId;

      // Actualizaci√≥n: El pasajero mismo o un administrador
      allow update: if isOwner(passengerId) || isAdmin();

      // Eliminaci√≥n: Solo administradores
      allow delete: if isAdmin();
    }

    // ===== REGLAS PARA VIAJES (TRIPS) =====

    match /trips/{tripId} {
      // Lectura: Participantes del viaje o administrador
      allow read: if isAuthenticated() &&
                     (resource.data.passengerId == request.auth.uid ||
                      resource.data.driverId == request.auth.uid ||
                      isAdmin());

      // Creaci√≥n: Cualquier usuario autenticado
      allow create: if isAuthenticated();

      // Actualizaci√≥n: Participantes del viaje o administrador
      allow update: if isAuthenticated() &&
                      (resource.data.passengerId == request.auth.uid ||
                       resource.data.driverId == request.auth.uid ||
                       isAdmin());

      // Eliminaci√≥n: Solo administradores
      allow delete: if isAdmin();
    }

    // ===== REGLAS PARA VIAJES (RIDES) =====

    match /rides/{rideId} {
      // ‚úÖ READ: Permitir lectura de documentos donde el usuario es participante
      // Firebase eval√∫a esta condici√≥n para cada documento retornado por la query
      // IMPORTANTE: Para queries, esta condici√≥n se eval√∫a DESPU√âS de obtener documentos
      // Por lo tanto, la query debe ser capaz de ejecutarse primero
      allow read: if isAuthenticated() &&
                     (resource.data.passengerId == request.auth.uid ||
                      resource.data.driverId == request.auth.uid ||
                      isAdmin());

      // Creaci√≥n: Cualquier usuario autenticado puede crear un viaje
      allow create: if isAuthenticated();

      // Actualizaci√≥n: Solo participantes del viaje o administrador
      allow update: if isAuthenticated() &&
                      (resource.data.passengerId == request.auth.uid ||
                       resource.data.driverId == request.auth.uid ||
                       isAdmin());

      // Eliminaci√≥n: Solo administradores
      allow delete: if isAdmin();
    }

    // ===== REGLAS PARA CALIFICACIONES (RATINGS) =====

    match /ratings/{ratingId} {
      // Lectura: Usuarios involucrados o administrador
      allow read: if isAuthenticated() &&
                     (resource.data.fromUserId == request.auth.uid ||
                      resource.data.toUserId == request.auth.uid ||
                      isAdmin());

      // Creaci√≥n: Usuario autenticado
      allow create: if isAuthenticated();

      // ‚úÖ SEGURIDAD: Las calificaciones NO se pueden editar (evitar manipulaci√≥n)
      allow update: if false;

      // Eliminaci√≥n: Solo administradores
      allow delete: if isAdmin();
    }

    // ===== REGLAS PARA MENSAJES DE CHAT =====

    match /chats/{chatId}/messages/{messageId} {
      // Lectura: Solo participantes del chat o admin
      allow read: if isAuthenticated() &&
                     (get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]) ||
                      isAdmin());

      // Creaci√≥n: Solo participantes del chat
      allow create: if isAuthenticated() &&
                      get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]);

      // Los mensajes NO se pueden editar (integridad del historial)
      allow update: if false;

      // Eliminaci√≥n: Solo administradores
      allow delete: if isAdmin();
    }

    // ===== REGLAS PARA CHATS =====

    match /chats/{chatId} {
      // Lectura: Solo participantes del chat o admin
      allow read: if isAuthenticated() &&
                     (resource.data.participants.hasAny([request.auth.uid]) || isAdmin());

      // Creaci√≥n: Usuarios autenticados
      allow create: if isAuthenticated();

      // Actualizaci√≥n: Solo participantes o admin
      allow update: if isAuthenticated() &&
                      (resource.data.participants.hasAny([request.auth.uid]) || isAdmin());

      // Eliminaci√≥n: Solo administradores
      allow delete: if isAdmin();
    }

    // ===== REGLAS PARA NOTIFICACIONES =====

    match /notifications/{notificationId} {
      // Lectura: Solo el destinatario o administrador
      allow read: if isAuthenticated() &&
                     (resource.data.userId == request.auth.uid || isAdmin());

      // Creaci√≥n: Solo administrador (sistema)
      allow create: if isAdmin();

      // Actualizaci√≥n: El destinatario o administrador
      allow update: if isAuthenticated() &&
                      (resource.data.userId == request.auth.uid || isAdmin());

      // Eliminaci√≥n: El destinatario o administrador
      allow delete: if isAuthenticated() &&
                      (resource.data.userId == request.auth.uid || isAdmin());
    }

    // ===== REGLAS PARA TICKETS DE SOPORTE =====

    match /supportTickets/{ticketId} {
      // Lectura: El creador del ticket o administrador
      allow read: if isAuthenticated() &&
                     (resource.data.userId == request.auth.uid || isAdmin());

      // Creaci√≥n: Cualquier usuario autenticado
      allow create: if isAuthenticated();

      // Actualizaci√≥n: El creador o administrador
      allow update: if isAuthenticated() &&
                      (resource.data.userId == request.auth.uid || isAdmin());

      // Eliminaci√≥n: Solo administradores
      allow delete: if isAdmin();
    }

    // ===== REGLAS PARA CONFIGURACI√ìN (P√∫blicas) =====

    match /config/{document} {
      // Lectura: P√∫blico
      allow read: if true;

      // Escritura: Solo administradores
      allow write: if isAdmin();
    }

    // ===== REGLAS PARA TARIFAS (P√∫blicas) =====

    match /rates/{rateId} {
      // Lectura: P√∫blico
      allow read: if true;

      // Escritura: Solo administradores
      allow write: if isAdmin();
    }

    // ===== REGLAS PARA PROMOCIONES (P√∫blicas) =====

    match /promotions/{promoId} {
      // Lectura: P√∫blico
      allow read: if true;

      // Escritura: Solo administradores
      allow write: if isAdmin();
    }

    // ===== REGLAS PARA M√âTODO DE PAGO =====

    match /paymentMethods/{methodId} {
      // Lectura: Solo el propietario o administrador
      allow read: if isAuthenticated() &&
                     (resource.data.userId == request.auth.uid || isAdmin());

      // Creaci√≥n: El usuario creando su m√©todo de pago
      allow create: if isAuthenticated() &&
                      request.resource.data.userId == request.auth.uid;

      // Actualizaci√≥n: El propietario o administrador
      allow update: if isAuthenticated() &&
                      (resource.data.userId == request.auth.uid || isAdmin());

      // Eliminaci√≥n: El propietario o administrador
      allow delete: if isAuthenticated() &&
                      (resource.data.userId == request.auth.uid || isAdmin());
    }

    // ===== REGLAS PARA AUDITOR√çA (Solo Lectura para Admins) =====

    match /auditLogs/{logId} {
      // Lectura: Solo administradores
      allow read: if isAdmin();

      // Escritura: Solo sistema (Cloud Functions)
      allow write: if false;
    }

    // ===== REGLAS PARA LOGS DE SEGURIDAD =====

    match /security_logs/{logId} {
      // Lectura: Solo administradores
      allow read: if isAdmin();

      // Creaci√≥n: Usuarios autenticados pueden registrar eventos de seguridad
      // (login, logout, cambios de contrase√±a, intentos fallidos, etc.)
      allow create: if isAuthenticated();

      // Actualizaci√≥n y eliminaci√≥n: NO permitidas (integridad de logs)
      allow update: if false;
      allow delete: if false;
    }

    // ===== REGLAS PARA LOGROS/ACHIEVEMENTS =====

    match /achievements/{achievementId} {
      // Lectura: Solo el propietario del logro o administrador
      allow read: if isAuthenticated() &&
                     (resource.data.userId == request.auth.uid || isAdmin());

      // Creaci√≥n: Solo sistema/Cloud Functions o administradores
      allow create: if isAdmin();

      // Actualizaci√≥n: Solo sistema/Cloud Functions o administradores
      allow update: if isAdmin();

      // Eliminaci√≥n: Solo administradores
      allow delete: if isAdmin();
    }

    // ===== REGLAS PARA NEGOCIACIONES DE PRECIO =====

    match /price_negotiations/{negotiationId} {
      // Lectura: El conductor o pasajero involucrado, o administrador
      allow read: if isAuthenticated() &&
                     (resource.data.driverId == request.auth.uid ||
                      resource.data.passengerId == request.auth.uid ||
                      isAdmin());

      // Creaci√≥n: El pasajero puede crear una negociaci√≥n
      allow create: if isAuthenticated() &&
                      request.resource.data.passengerId == request.auth.uid;

      // Actualizaci√≥n: El conductor o pasajero involucrado, o administrador
      allow update: if isAuthenticated() &&
                      (resource.data.driverId == request.auth.uid ||
                       resource.data.passengerId == request.auth.uid ||
                       isAdmin());

      // Eliminaci√≥n: Solo administradores
      allow delete: if isAdmin();
    }

    // ===== üí≥ TRANSACCIONES DE RECARGA (MERCADOPAGO) =====
    match /recharge_transactions/{transactionId} {
      // Lectura: El usuario propietario, administrador, o Cloud Functions (sin auth)
      allow read: if (isAuthenticated() &&
                     (resource.data.userId == request.auth.uid || isAdmin()))
                     || request.auth == null;

      // Creaci√≥n: Solo desde backend (Firebase Functions - sin auth)
      allow create: if request.auth == null;

      // Actualizaci√≥n: Solo desde backend (Firebase Functions - sin auth)
      allow update: if request.auth == null;

      // Eliminaci√≥n: Solo administradores o Cloud Functions
      allow delete: if isAdmin() || request.auth == null;
    }

    // ===== üí∏ SOLICITUDES DE RETIRO (CONDUCTORES) =====
    match /withdrawal_requests/{withdrawalId} {
      // Lectura: El conductor propietario, administrador, o Cloud Functions
      allow read: if (isAuthenticated() &&
                     (resource.data.driverId == request.auth.uid || isAdmin()))
                     || request.auth == null;

      // Creaci√≥n: Conductores para s√≠ mismos o Cloud Functions
      allow create: if (isAuthenticated() &&
                      isDriver() &&
                      request.resource.data.driverId == request.auth.uid &&
                      request.resource.data.status == 'pending' &&
                      request.resource.data.amount >= 50) // Monto m√≠nimo S/ 50
                      || request.auth == null;

      // Actualizaci√≥n: Solo backend (Cloud Functions - sin auth)
      allow update: if request.auth == null;

      // Eliminaci√≥n: Solo administradores o Cloud Functions
      allow delete: if isAdmin() || request.auth == null;
    }
  }
}
