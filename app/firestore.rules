rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===== FUNCIONES HELPER DE AUTENTICACI√ìN Y AUTORIZACI√ìN =====

    // Verificar si el usuario est√° autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Verificar si es el propietario del documento
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ‚úÖ CORREGIDO: Verificar si es administrador (usar 'userType' en vez de 'role')
    function isAdmin() {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'admin';
    }

    // Verificar si es conductor (incluye dual)
    function isDriver() {
      return isAuthenticated() &&
             (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'driver' ||
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'dual');
    }

    // ‚úÖ CR√çTICO: Detectar si se intenta modificar campos protegidos
    // Estos campos SOLO pueden ser modificados por administradores
    // NOTA: 'email' fue REMOVIDO de campos protegidos para permitir que usuarios
    // actualicen su email durante el flujo de completar perfil (login social)
    function hasProtectedFieldChanges() {
      return request.resource.data.diff(resource.data).affectedKeys()
        .hasAny(['isAdmin', 'isVerified', 'id', 'createdAt', 'rating', 'totalTrips']);
    }

    // ‚úÖ NUEVO: Validar upgrade a conductor leg√≠timo
    // Permite cambiar userType SOLO de 'passenger' a 'dual' con driverStatus 'pending_approval'
    function isValidDriverUpgrade() {
      let oldType = resource.data.userType;
      let newType = request.resource.data.userType;
      let newStatus = request.resource.data.get('driverStatus', '');
      let newMode = request.resource.data.get('currentMode', '');
      let newRoles = request.resource.data.get('availableRoles', []);

      return oldType == 'passenger' &&
             newType == 'dual' &&
             newStatus == 'pending_approval' &&
             newMode == 'driver' &&
             newRoles.hasAll(['passenger', 'driver']) &&
             newRoles.size() == 2;
    }

    // ‚úÖ PROTECCI√ìN DE C√ìDIGOS DE VERIFICACI√ìN MUTUA:
    // Los c√≥digos NO se pueden modificar directamente por clientes
    function hasVerificationCodeChanges() {
      return request.resource.data.diff(resource.data).affectedKeys()
        .hasAny(['passengerVerificationCode', 'driverVerificationCode']);
    }

    // ===== REGLAS PARA COLECCI√ìN DE USUARIOS =====

    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();

      // ‚úÖ CORREGIDO: Permitir queries limitados PRIMERO (para usuarios nuevos en login social)
      // CR√çTICO: Evaluar la condici√≥n simple ANTES de isAdmin() para evitar errores con usuarios nuevos
      // - Usuarios autenticados: queries con limit <= 10 (para verificar email duplicado al hacer login)
      // - Admins: queries sin l√≠mite
      allow list: if (isAuthenticated() && request.query.limit <= 10) || isAdmin();

      // ‚úÖ CR√çTICO: Permitir crear documento SI el usuario est√° autenticado y es su propio documento
      allow create: if isAuthenticated() && request.auth.uid == userId;

      // Protecci√≥n contra escalaci√≥n de privilegios excepto upgrade a conductor v√°lido
      allow update: if isOwner(userId) && (!hasProtectedFieldChanges() || isValidDriverUpgrade());
      allow update: if isAdmin();

      allow delete: if isAdmin();

      match /favorites/{favoriteId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }

      // ‚úÖ NUEVO: Reglas para m√©todos de pago
      match /payment_methods/{methodId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }

      // ‚úÖ NUEVO: Reglas para promociones usadas por el usuario
      match /used_promotions/{promoId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId);
      }
    }

    // ===== REGLAS PARA CONDUCTORES =====

    match /drivers/{driverId} {
      // Lectura: Cualquier usuario autenticado (para ver conductores disponibles)
      allow read: if isAuthenticated();

      // Creaci√≥n: Usuario creando su propio perfil de conductor
      allow create: if isAuthenticated() && request.auth.uid == driverId;

      // Actualizaci√≥n: El conductor mismo o un administrador
      allow update: if isOwner(driverId) || isAdmin();

      // Eliminaci√≥n: Solo administradores
      allow delete: if isAdmin();

      // ===== SUBCOLECCI√ìN: DOCUMENTOS DEL CONDUCTOR =====
      match /documents/{documentId} {
        // Lectura: El conductor propietario o administrador
        allow read: if isOwner(driverId) || isAdmin();

        // Creaci√≥n: El conductor puede subir sus propios documentos
        allow create: if isOwner(driverId);

        // Actualizaci√≥n: El conductor o administrador (para actualizar estado de aprobaci√≥n)
        allow update: if isOwner(driverId) || isAdmin();

        // Eliminaci√≥n: El conductor o administrador
        allow delete: if isOwner(driverId) || isAdmin();
      }
    }

    // ===== REGLAS PARA PASAJEROS =====

    match /passengers/{passengerId} {
      // Lectura: El pasajero mismo, conductores, o admin
      allow read: if isOwner(passengerId) || isDriver() || isAdmin();

      // Creaci√≥n: El pasajero mismo al registrarse
      allow create: if isAuthenticated() && request.auth.uid == passengerId;

      // Actualizaci√≥n: El pasajero mismo o un administrador
      allow update: if isOwner(passengerId) || isAdmin();

      // Eliminaci√≥n: Solo administradores
      allow delete: if isAdmin();
    }

    // ===== REGLAS PARA VIAJES (TRIPS) =====

    match /trips/{tripId} {
      // ‚úÖ CORREGIDO: Separar get (documento individual) y list (queries)
      // GET: Participantes del viaje o administrador
      allow get: if isAuthenticated() &&
                    (resource.data.userId == request.auth.uid ||
                     resource.data.driverId == request.auth.uid ||
                     isAdmin());

      // LIST: Admins pueden hacer queries, participantes solo ven sus propios viajes
      allow list: if isAdmin();

      // Creaci√≥n: Cualquier usuario autenticado
      allow create: if isAuthenticated();

      // Actualizaci√≥n: Participantes del viaje o administrador
      allow update: if isAuthenticated() &&
                      (resource.data.userId == request.auth.uid ||
                       resource.data.driverId == request.auth.uid ||
                       isAdmin());

      // Eliminaci√≥n: Solo administradores
      allow delete: if isAdmin();
    }

    // ===== REGLAS PARA VIAJES (RIDES) =====

    match /rides/{rideId} {
      // ‚úÖ CORREGIDO: Separar get y list para mejor control
      // GET: Participantes del viaje o administrador
      allow get: if isAuthenticated() &&
                    (resource.data.userId == request.auth.uid ||
                     resource.data.driverId == request.auth.uid ||
                     isAdmin());

      // LIST: Admins pueden hacer queries sin restricci√≥n
      // Usuarios autenticados pueden hacer queries limitadas (max 100 resultados)
      // NOTA: La app filtra por userId/passengerId/driverId en el cliente
      allow list: if isAdmin() ||
                     (isAuthenticated() && request.query.limit <= 100);

      // Creaci√≥n: Cualquier usuario autenticado puede crear un viaje
      allow create: if isAuthenticated();

      // Actualizaci√≥n: Solo participantes del viaje o administrador
      // ‚úÖ CR√çTICO: NO permitir cambios en c√≥digos de verificaci√≥n
      allow update: if isAuthenticated() &&
                      (resource.data.userId == request.auth.uid ||
                       resource.data.driverId == request.auth.uid ||
                       isAdmin()) &&
                      !hasVerificationCodeChanges(); // Los c√≥digos NO se pueden cambiar

      // Eliminaci√≥n: Solo administradores
      allow delete: if isAdmin();
    }

    // ===== REGLAS PARA CALIFICACIONES (RATINGS) =====

    match /ratings/{ratingId} {
      // Lectura: Usuarios involucrados o administrador
      allow read: if isAuthenticated() &&
                     (resource.data.fromUserId == request.auth.uid ||
                      resource.data.toUserId == request.auth.uid ||
                      isAdmin());

      // Creaci√≥n: Usuario autenticado
      allow create: if isAuthenticated();

      // ‚úÖ SEGURIDAD: Las calificaciones NO se pueden editar (evitar manipulaci√≥n)
      allow update: if false;

      // Eliminaci√≥n: Solo administradores
      allow delete: if isAdmin();
    }

    // ===== REGLAS PARA MENSAJES DE CHAT =====

    match /chats/{chatId}/messages/{messageId} {
      // Lectura: Solo participantes del chat o admin
      allow read: if isAuthenticated() &&
                     (get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]) ||
                      isAdmin());

      // Creaci√≥n: Solo participantes del chat
      allow create: if isAuthenticated() &&
                      get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]);

      // Los mensajes NO se pueden editar (integridad del historial)
      allow update: if false;

      // Eliminaci√≥n: Solo administradores
      allow delete: if isAdmin();
    }

    // ===== REGLAS PARA CHATS =====

    match /chats/{chatId} {
      // Lectura: Solo participantes del chat o admin
      allow read: if isAuthenticated() &&
                     (resource.data.participants.hasAny([request.auth.uid]) || isAdmin());

      // Creaci√≥n: Usuarios autenticados
      allow create: if isAuthenticated();

      // Actualizaci√≥n: Solo participantes o admin
      allow update: if isAuthenticated() &&
                      (resource.data.participants.hasAny([request.auth.uid]) || isAdmin());

      // Eliminaci√≥n: Solo administradores
      allow delete: if isAdmin();
    }

    // ===== REGLAS PARA NOTIFICACIONES =====

    match /notifications/{notificationId} {
      // Lectura: Solo el destinatario o administrador
      allow read: if isAuthenticated() &&
                     (resource.data.userId == request.auth.uid || isAdmin());

      // Creaci√≥n: Usuarios autenticados pueden crear notificaciones
      // (para notificar a conductores de nuevas solicitudes, etc.)
      allow create: if isAuthenticated();

      // Actualizaci√≥n: El destinatario o administrador
      allow update: if isAuthenticated() &&
                      (resource.data.userId == request.auth.uid || isAdmin());

      // Eliminaci√≥n: El destinatario o administrador
      allow delete: if isAuthenticated() &&
                      (resource.data.userId == request.auth.uid || isAdmin());
    }

    // ===== REGLAS PARA TICKETS DE SOPORTE =====

    match /supportTickets/{ticketId} {
      // Lectura: El creador del ticket o administrador
      allow read: if isAuthenticated() &&
                     (resource.data.userId == request.auth.uid || isAdmin());

      // Creaci√≥n: Cualquier usuario autenticado
      allow create: if isAuthenticated();

      // Actualizaci√≥n: El creador o administrador
      allow update: if isAuthenticated() &&
                      (resource.data.userId == request.auth.uid || isAdmin());

      // Eliminaci√≥n: Solo administradores
      allow delete: if isAdmin();
    }

    // ===== REGLAS PARA CONFIGURACI√ìN DEL SISTEMA (Solo Admin) =====

    match /settings/{settingId} {
      // Lectura: Solo administradores
      allow read: if isAdmin();

      // Escritura: Solo administradores
      allow write: if isAdmin();
    }

    // ===== REGLAS PARA ZONAS (Lectura P√∫blica) =====

    match /zones/{zoneId} {
      // Lectura: P√∫blico (para calcular tarifas)
      allow read: if true;

      // Escritura: Solo administradores
      allow write: if isAdmin();
    }

    // ===== REGLAS PARA CONFIGURACI√ìN (P√∫blicas) =====

    match /config/{document} {
      // Lectura: P√∫blico
      allow read: if true;

      // Escritura: Solo administradores
      allow write: if isAdmin();
    }

    // ===== REGLAS PARA TARIFAS (P√∫blicas) =====

    match /rates/{rateId} {
      // Lectura: P√∫blico
      allow read: if true;

      // Escritura: Solo administradores
      allow write: if isAdmin();
    }

    // ===== REGLAS PARA PROMOCIONES =====

    match /promotions/{promoId} {
      // ‚úÖ GET: Lectura individual p√∫blica (para validar c√≥digo de promoci√≥n)
      allow get: if true;

      // ‚úÖ LIST: Queries de promociones activas
      // - Usuarios autenticados: filtrar por targetUserType
      // - No autenticados: solo promociones 'both'
      // - Admins: sin restricci√≥n
      allow list: if isAdmin() ||
                     (isAuthenticated() &&
                      request.query.limit <= 100) ||
                     (!isAuthenticated() &&
                      request.query.limit <= 20);

      // Escritura: Solo administradores
      allow write: if isAdmin();
    }

    // ===== REGLAS PARA M√âTODO DE PAGO =====

    match /paymentMethods/{methodId} {
      // Lectura: Solo el propietario o administrador
      allow read: if isAuthenticated() &&
                     (resource.data.userId == request.auth.uid || isAdmin());

      // Creaci√≥n: El usuario creando su m√©todo de pago
      allow create: if isAuthenticated() &&
                      request.resource.data.userId == request.auth.uid;

      // Actualizaci√≥n: El propietario o administrador
      allow update: if isAuthenticated() &&
                      (resource.data.userId == request.auth.uid || isAdmin());

      // Eliminaci√≥n: El propietario o administrador
      allow delete: if isAuthenticated() &&
                      (resource.data.userId == request.auth.uid || isAdmin());
    }

    // ===== REGLAS PARA AUDITOR√çA (Solo Lectura para Admins) =====

    match /auditLogs/{logId} {
      // Lectura: Solo administradores
      allow read: if isAdmin();

      // Escritura: Solo sistema (Cloud Functions)
      allow write: if false;
    }

    // ===== REGLAS PARA LOGS DE SEGURIDAD =====

    match /security_logs/{logId} {
      // Lectura: Solo administradores
      allow read: if isAdmin();

      // Creaci√≥n: Usuarios autenticados pueden registrar eventos de seguridad
      // (login, logout, cambios de contrase√±a, intentos fallidos, etc.)
      allow create: if isAuthenticated();

      // Actualizaci√≥n y eliminaci√≥n: NO permitidas (integridad de logs)
      allow update: if false;
      allow delete: if false;
    }

    // ===== REGLAS PARA LOGROS/ACHIEVEMENTS =====

    match /achievements/{achievementId} {
      // ‚úÖ CORREGIDO: GET individual - el propietario del logro o admin
      allow get: if isAuthenticated() &&
                    (resource.data.userId == request.auth.uid || isAdmin());

      // ‚úÖ CORREGIDO: LIST - usuarios autenticados pueden listar (filtro en cliente)
      // Necesario para que conductores puedan ver sus propios logros
      allow list: if isAuthenticated();

      // Creaci√≥n: Solo sistema/Cloud Functions o administradores
      allow create: if isAdmin();

      // Actualizaci√≥n: Solo sistema/Cloud Functions o administradores
      allow update: if isAdmin();

      // Eliminaci√≥n: Solo administradores
      allow delete: if isAdmin();
    }

    // ===== REGLAS PARA NEGOCIACIONES DE PRECIO =====

    match /price_negotiations/{negotiationId} {
      // Lectura: El conductor o pasajero involucrado, o administrador
      allow read: if isAuthenticated() &&
                     (resource.data.driverId == request.auth.uid ||
                      resource.data.passengerId == request.auth.uid ||
                      isAdmin());

      // Creaci√≥n: El pasajero puede crear una negociaci√≥n
      allow create: if isAuthenticated() &&
                      request.resource.data.passengerId == request.auth.uid;

      // Actualizaci√≥n: El conductor o pasajero involucrado, o administrador
      allow update: if isAuthenticated() &&
                      (resource.data.driverId == request.auth.uid ||
                       resource.data.passengerId == request.auth.uid ||
                       isAdmin());

      // Eliminaci√≥n: Solo administradores
      allow delete: if isAdmin();
    }

    // ===== REGLAS PARA NEGOCIACIONES (ALIAS) =====
    // Colecci√≥n usada por la app para el sistema de negociaci√≥n estilo InDriver

    match /negotiations/{negotiationId} {
      // GET: Cualquier usuario autenticado puede ver negociaciones activas
      // (conductores necesitan ver las solicitudes disponibles)
      allow get: if isAuthenticated();

      // LIST: Conductores y pasajeros pueden ver listado
      // Los conductores ven solicitudes activas para ofertar
      // Los pasajeros ven sus propias negociaciones
      allow list: if isAuthenticated();

      // Creaci√≥n: Cualquier usuario autenticado (pasajeros crean solicitudes)
      allow create: if isAuthenticated();

      // Actualizaci√≥n: Participantes o cualquier conductor (para hacer ofertas)
      allow update: if isAuthenticated();

      // Eliminaci√≥n: El pasajero creador o administrador
      allow delete: if isAuthenticated() &&
                      (resource.data.passengerId == request.auth.uid || isAdmin());

      // Subcolecci√≥n de ofertas de conductores
      match /offers/{offerId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if isAuthenticated();
        allow delete: if isAdmin();
      }
    }

    // ===== üí≥ TRANSACCIONES DE RECARGA (MERCADOPAGO) =====
    match /recharge_transactions/{transactionId} {
      // Lectura: El usuario propietario, administrador, o Cloud Functions (sin auth)
      allow read: if (isAuthenticated() &&
                     (resource.data.userId == request.auth.uid || isAdmin()))
                     || request.auth == null;

      // Creaci√≥n: Solo desde backend (Firebase Functions - sin auth)
      allow create: if request.auth == null;

      // Actualizaci√≥n: Solo desde backend (Firebase Functions - sin auth)
      allow update: if request.auth == null;

      // Eliminaci√≥n: Solo administradores o Cloud Functions
      allow delete: if isAdmin() || request.auth == null;
    }

    // ===== üí∏ SOLICITUDES DE RETIRO (CONDUCTORES) =====
    match /withdrawal_requests/{withdrawalId} {
      // ‚úÖ CORREGIDO: Separar get y list
      // GET: El conductor propietario, administrador, o Cloud Functions
      allow get: if (isAuthenticated() &&
                     (resource.data.driverId == request.auth.uid || isAdmin()))
                     || request.auth == null;

      // ‚úÖ CORREGIDO: Permitir a conductores listar sus propios retiros
      allow list: if isAuthenticated() || isAdmin() || request.auth == null;

      // Creaci√≥n: Conductores para s√≠ mismos o Cloud Functions
      allow create: if (isAuthenticated() &&
                      isDriver() &&
                      request.resource.data.driverId == request.auth.uid &&
                      request.resource.data.status == 'pending' &&
                      request.resource.data.amount >= 50) // Monto m√≠nimo S/ 50
                      || request.auth == null;

      // Actualizaci√≥n: Solo backend (Cloud Functions - sin auth)
      allow update: if request.auth == null;

      // Eliminaci√≥n: Solo administradores o Cloud Functions
      allow delete: if isAdmin() || request.auth == null;
    }

    // ===== üí∏ RETIROS (ALIAS PARA WITHDRAWAL_REQUESTS) =====
    match /withdrawals/{withdrawalId} {
      // Mismas reglas que withdrawal_requests para compatibilidad
      allow get: if (isAuthenticated() &&
                     (resource.data.driverId == request.auth.uid || isAdmin()))
                     || request.auth == null;

      // ‚úÖ CORREGIDO: Permitir a conductores listar sus propios retiros
      allow list: if isAuthenticated() || isAdmin() || request.auth == null;

      allow create: if (isAuthenticated() &&
                      isDriver() &&
                      request.resource.data.driverId == request.auth.uid)
                      || request.auth == null;

      allow update: if request.auth == null || isAdmin();
      allow delete: if isAdmin() || request.auth == null;
    }

    // ===== üö® DISPUTAS Y REPORTES =====
    match /disputes/{disputeId} {
      // GET: Participantes de la disputa o administrador
      allow get: if isAuthenticated() &&
                    (resource.data.reporterId == request.auth.uid ||
                     resource.data.reportedUserId == request.auth.uid ||
                     isAdmin());

      // LIST: Solo administradores pueden listar todas las disputas
      allow list: if isAdmin();

      // Creaci√≥n: Usuarios autenticados pueden reportar
      allow create: if isAuthenticated() &&
                      request.resource.data.reporterId == request.auth.uid;

      // Actualizaci√≥n: Solo administradores (para resolver disputas)
      allow update: if isAdmin();

      // Eliminaci√≥n: Solo administradores
      allow delete: if isAdmin();
    }

    // ===== üö® EMERGENCIAS (BOT√ìN DE P√ÅNICO) =====
    match /emergencies/{emergencyId} {
      // GET: El usuario que cre√≥ la emergencia, admin, o Cloud Functions
      allow get: if (isAuthenticated() &&
                     (resource.data.userId == request.auth.uid || isAdmin()))
                     || request.auth == null;

      // LIST: Solo administradores o Cloud Functions
      allow list: if isAdmin() || request.auth == null;

      // Creaci√≥n: Usuario autenticado o Cloud Functions
      allow create: if (isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid)
                       || request.auth == null;

      // Actualizaci√≥n: Solo administradores o Cloud Functions
      allow update: if isAdmin() || request.auth == null;

      // Eliminaci√≥n: Solo administradores
      allow delete: if isAdmin();
    }

    // ===== üöó VEH√çCULOS DE CONDUCTORES =====
    match /vehicles/{vehicleId} {
      // GET: El conductor propietario o administrador
      allow get: if isAuthenticated() &&
                   (resource.data.driverId == request.auth.uid || isAdmin());

      // LIST: Todos los usuarios autenticados (para ver veh√≠culos disponibles)
      // Conductores pueden ver sus propios veh√≠culos con query
      allow list: if isAuthenticated();

      // Creaci√≥n: Conductores pueden crear sus propios veh√≠culos
      allow create: if isAuthenticated() &&
                      isDriver() &&
                      request.resource.data.driverId == request.auth.uid;

      // Actualizaci√≥n: El conductor propietario o administrador
      allow update: if isAuthenticated() &&
                      (resource.data.driverId == request.auth.uid || isAdmin());

      // Eliminaci√≥n: El conductor propietario o administrador
      allow delete: if isAuthenticated() &&
                      (resource.data.driverId == request.auth.uid || isAdmin());
    }

    // ===== üìä TRANSACCIONES Y WALLET =====
    match /transactions/{transactionId} {
      // GET: El usuario propietario, administrador, o Cloud Functions
      allow get: if (isAuthenticated() &&
                     (resource.data.userId == request.auth.uid || isAdmin()))
                     || request.auth == null;

      // ‚úÖ CORREGIDO: Permitir a usuarios autenticados listar sus transacciones
      // El filtro por userId se hace en el cliente
      allow list: if isAuthenticated() || isAdmin() || request.auth == null;

      // Creaci√≥n: Solo desde backend (Cloud Functions - sin auth)
      allow create: if request.auth == null;

      // Actualizaci√≥n: Solo desde backend (Cloud Functions - sin auth)
      allow update: if request.auth == null;

      // Eliminaci√≥n: Solo administradores
      allow delete: if isAdmin();
    }

    // ===== üí∞ WALLETS DE CONDUCTORES =====
    match /wallets/{walletId} {
      // GET: El conductor propietario, administrador, o Cloud Functions
      allow get: if (isAuthenticated() &&
                     (resource.data.driverId == request.auth.uid || isAdmin()))
                     || request.auth == null;

      // LIST: Solo administradores o Cloud Functions
      allow list: if isAdmin() || request.auth == null;

      // Creaci√≥n: Conductores para s√≠ mismos o Cloud Functions
      allow create: if (isAuthenticated() &&
                       isDriver() &&
                       request.resource.data.driverId == request.auth.uid)
                       || request.auth == null;

      // Actualizaci√≥n: Solo Cloud Functions (para evitar manipulaci√≥n de balance)
      allow update: if request.auth == null;

      // Eliminaci√≥n: Solo administradores
      allow delete: if isAdmin();
    }

    // ===== üéØ C√ìDIGOS DE DESCUENTO Y CUPONES =====
    match /discount_codes/{codeId} {
      // GET: Cualquier usuario autenticado (para validar c√≥digo)
      allow get: if isAuthenticated();

      // LIST: Solo administradores
      allow list: if isAdmin();

      // Creaci√≥n: Solo administradores
      allow create: if isAdmin();

      // Actualizaci√≥n: Solo administradores
      allow update: if isAdmin();

      // Eliminaci√≥n: Solo administradores
      allow delete: if isAdmin();
    }

    // ===== üì± FCM TOKENS (PARA NOTIFICACIONES PUSH) =====
    match /fcm_tokens/{tokenId} {
      // GET: El usuario propietario o administrador
      allow get: if isAuthenticated() &&
                   (resource.data.userId == request.auth.uid || isAdmin());

      // LIST: Solo administradores (para env√≠o masivo de notificaciones)
      allow list: if isAdmin();

      // Creaci√≥n: El usuario guardando su propio token
      allow create: if isAuthenticated() &&
                      request.resource.data.userId == request.auth.uid;

      // Actualizaci√≥n: El usuario actualizando su token o administrador
      allow update: if isAuthenticated() &&
                      (resource.data.userId == request.auth.uid || isAdmin());

      // Eliminaci√≥n: El usuario eliminando su token o administrador
      allow delete: if isAuthenticated() &&
                      (resource.data.userId == request.auth.uid || isAdmin());
    }

    // ===== üìç UBICACIONES EN TIEMPO REAL =====
    match /locations/{locationId} {
      // GET: Usuarios autenticados (para tracking)
      allow get: if isAuthenticated();

      // LIST: Solo administradores
      allow list: if isAdmin();

      // Creaci√≥n: Conductores actualizando su ubicaci√≥n
      allow create: if isAuthenticated() &&
                      isDriver() &&
                      request.resource.data.driverId == request.auth.uid;

      // Actualizaci√≥n: El conductor propietario
      allow update: if isAuthenticated() &&
                      isDriver() &&
                      resource.data.driverId == request.auth.uid;

      // Eliminaci√≥n: El conductor o administrador
      allow delete: if isAuthenticated() &&
                      (isDriver() && resource.data.driverId == request.auth.uid ||
                       isAdmin());
    }

    // ===== üèÅ VIAJES ACTIVOS (CACH√â EN TIEMPO REAL) =====
    match /active_rides/{rideId} {
      // GET: Participantes del viaje o administrador
      allow get: if isAuthenticated() &&
                   (resource.data.userId == request.auth.uid ||
                    resource.data.driverId == request.auth.uid ||
                    isAdmin());

      // LIST: Conductores disponibles (para ver solicitudes cercanas)
      allow list: if isAuthenticated() && (isDriver() || isAdmin());

      // Creaci√≥n: Pasajeros creando solicitud
      allow create: if isAuthenticated() &&
                      request.resource.data.userId == request.auth.uid;

      // Actualizaci√≥n: Participantes o administrador
      allow update: if isAuthenticated() &&
                      (resource.data.userId == request.auth.uid ||
                       resource.data.driverId == request.auth.uid ||
                       isAdmin());

      // Eliminaci√≥n: Participantes o administrador
      allow delete: if isAuthenticated() &&
                      (resource.data.userId == request.auth.uid ||
                       resource.data.driverId == request.auth.uid ||
                       isAdmin());
    }

    // ===== üìß INVITACIONES Y REFERIDOS =====
    match /referrals/{referralId} {
      // GET: El usuario que hizo la referencia o el referido
      allow get: if isAuthenticated() &&
                   (resource.data.referrerId == request.auth.uid ||
                    resource.data.referredUserId == request.auth.uid ||
                    isAdmin());

      // LIST: Solo administradores
      allow list: if isAdmin();

      // Creaci√≥n: Usuario autenticado haciendo referencia
      allow create: if isAuthenticated() &&
                      request.resource.data.referrerId == request.auth.uid;

      // Actualizaci√≥n: Solo Cloud Functions (para actualizar recompensas)
      allow update: if request.auth == null || isAdmin();

      // Eliminaci√≥n: Solo administradores
      allow delete: if isAdmin();
    }

    // ===== üìä M√âTRICAS Y ESTAD√çSTICAS =====
    match /metrics/{metricId} {
      // Lectura: Solo administradores
      allow read: if isAdmin();

      // Escritura: Solo Cloud Functions
      allow write: if request.auth == null;
    }

    // ===== üîî PREFERENCIAS DE NOTIFICACIONES =====
    match /notification_preferences/{userId} {
      // Lectura: El usuario propietario o administrador
      allow read: if isAuthenticated() &&
                     (userId == request.auth.uid || isAdmin());

      // Creaci√≥n: El usuario creando sus preferencias
      allow create: if isAuthenticated() && userId == request.auth.uid;

      // Actualizaci√≥n: El usuario actualizando sus preferencias
      allow update: if isAuthenticated() && userId == request.auth.uid;

      // Eliminaci√≥n: El usuario o administrador
      allow delete: if isAuthenticated() &&
                      (userId == request.auth.uid || isAdmin());
    }

    // ===== üé´ TICKETS DE SOPORTE (ALIAS PARA supportTickets) =====
    match /support/{ticketId} {
      // Mismas reglas que supportTickets para compatibilidad
      allow read: if isAuthenticated() &&
                     (resource.data.userId == request.auth.uid || isAdmin());

      allow create: if isAuthenticated();

      allow update: if isAuthenticated() &&
                      (resource.data.userId == request.auth.uid || isAdmin());

      allow delete: if isAdmin();
    }

    // ===== üö´ BLOQUEOS DE USUARIOS =====
    match /blocked_users/{blockId} {
      // GET: El usuario que bloque√≥ o administrador
      allow get: if isAuthenticated() &&
                   (resource.data.blockedBy == request.auth.uid || isAdmin());

      // LIST: El usuario puede ver a qui√©n ha bloqueado
      allow list: if isAuthenticated();

      // Creaci√≥n: Usuario bloqueando a otro
      allow create: if isAuthenticated() &&
                      request.resource.data.blockedBy == request.auth.uid;

      // Actualizaci√≥n: No permitida (para desbloquear, eliminar el documento)
      allow update: if false;

      // Eliminaci√≥n: El usuario que bloque√≥ o administrador
      allow delete: if isAuthenticated() &&
                      (resource.data.blockedBy == request.auth.uid || isAdmin());
    }

    // ===== ‚öôÔ∏è CONFIGURACI√ìN DE LA APP =====
    match /app_config/{configId} {
      // Lectura: P√∫blico (versi√≥n m√≠nima, features habilitados, etc.)
      allow read: if true;

      // Escritura: Solo administradores
      allow write: if isAdmin();
    }

    // ===== üì¢ ANUNCIOS Y BANNERS =====
    match /announcements/{announcementId} {
      // Lectura: P√∫blico
      allow read: if true;

      // Escritura: Solo administradores
      allow write: if isAdmin();
    }
  }
}
